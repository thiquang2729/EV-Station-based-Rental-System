_format_version: "3.0"
_transform: true

# Declarative Kong configuration for Auth + Station services.
# Adjust service URLs to match your deployment topology.

services:
  - name: auth-service
    url: http://auth-backend:8000
    routes:
      - name: auth-service-routes
        paths:
          - /api/v1/auth
          - /api/v1/users
          - /api/v1/documents
          - /api/v1/upload
          - /api/v1/complaints
        strip_path: false

  - name: admin-svc
    url: http://admin-svc:3001
    routes:
      - name: admin-service-routes
        paths:
          - /api/v1/admin
        strip_path: false
      - name: admin-health-route
        paths:
          - /health/admin
        strip_path: true

  - name: rental-svc
    url: http://rental-svc:3002
    routes:
      - name: rental-bookings-route
        paths:
          - /api/v1/bookings
        strip_path: false
      - name: rental-health-route
        paths:
          - /health/rental
        strip_path: true

  - name: fleet-svc
    url: http://fleet-svc:3003
    routes:
      - name: fleet-vehicles-route
        paths:
          - /api/v1/vehicles
        strip_path: false
      - name: fleet-health-route
        paths:
          - /health/fleet
        strip_path: true

  - name: stations-service
    host: stations-upstream
    protocol: http
    routes:
      - name: stations-route
        paths:
          - /api/v1/stations
        strip_path: false

upstreams:
  - name: stations-upstream
    algorithm: round-robin
    targets:
      - target: rental-svc:3002
        weight: 50
      - target: fleet-svc:3003
        weight: 50

consumers:
  - username: auth-service
    custom_id: auth-service
    jwt_secrets:
      - key: auth-service
        algorithm: HS256
        secret: "{{ env 'KONG_JWT_SECRET' }}"

plugins:
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Requested-With
        - Origin
        - Access-Control-Request-Method
        - Access-Control-Request-Headers
      exposed_headers:
        - Authorization
        - Content-Type
      credentials: true
      max_age: 3600
      preflight_continue: false

  - name: request-transformer
    config:
      add:
        headers:
          - "Content-Type:application/json"
      remove:
        headers: []
      replace:
        headers: []
      append:
        headers: []

  - name: rate-limiting
    config:
      minute: "{{ env 'KONG_RATE_LIMIT_MINUTE' | default '1000' }}"
      hour: "{{ env 'KONG_RATE_LIMIT_HOUR' | default '10000' }}"
      policy: local

  - name: file-log
    config:
      path: /var/log/kong/requests.log

  - name: jwt
    service: rental-svc
    config:
      claims_to_verify:
        - exp
      key_claim_name: iss
      secret_is_base64: false

  - name: jwt
    service: fleet-svc
    config:
      claims_to_verify:
        - exp
      key_claim_name: iss
      secret_is_base64: false

  - name: jwt
    service: admin-svc
    config:
      claims_to_verify:
        - exp
      key_claim_name: iss
      secret_is_base64: false

  - name: jwt
    service: stations-service
    config:
      claims_to_verify:
        - exp
      key_claim_name: iss
      secret_is_base64: false
